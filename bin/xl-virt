#!/usr/bin/env bash

. "$HOME/.local/lib/xlotus/xlfns"

HELP="$XLOTUS_HELP"

printHelp () {
    cat "$HELP/xl-virt"
    cat "$HELP/footer"
}

randomMac () {
    # Generate a random mac address
    printf "52:54:%02x:%02x:%02x:%02x" \
        $(( RANDOM & 0xff)) \
        $(( RANDOM & 0xff )) \
        $(( RANDOM & 0xff)) \
        $(( RANDOM & 0xff ))
}

virtIsoDir="$(getConfig "virt_iso_dir")"
virtDriveDir="$(getConfig "virt_drive_dir")"

case $1 in
    -h|--help) printHelp ;;
    -i|--iso)
        iso=$(fd . "$HOME"/"$virtIsoDir" -t f | fzfcmd "ISO" -d/ --with-nth -1)
        drive=$(fd . "$HOME"/"$virtDriveDir" -t f | fzfcmd "Drive" -d/ --with-nth -1)

        if [ -n "$iso" ] && [ -n "$drive" ]; then
            nohup bash -c "qemu-system-x86_64 \
                -net nic,macaddr=$(randomMac),model=virtio \
                -net user \
                -vga virtio \
                -accel kvm \
                -cpu host \
                -boot order=d \
                -cdrom $iso \
                -drive file=$drive,format=raw \
                -m 1024M \
                -display gtk,show-menubar=off,full-screen=on &" 2&>/dev/null
        fi
        ;;

    -d|--drive)
        drive=$(fd . "$HOME"/"$virtDriveDir" -t f | fzfcmd "Drive" -d/ --with-nth -1)

        if [ -n "$drive" ]; then
            nohup bash -c "qemu-system-x86_64 \
                -net nic,macaddr=$(randomMac),model=virtio \
                -net user \
                -vga virtio \
                -accel kvm \
                -cpu host \
                -boot order=d \
                -drive file=$drive,format=raw \
                -m 1024M \
                -display gtk,show-menubar=off,full-screen=on &" 2&>/dev/null
        fi
        ;;

    -m|--mkdrive)
            ctxt g "\nCreating a new raw drive\n"
            read -r -p "Name of drive: " driveName
            read -r -p "Size of drive: " driveSize
            qemu-img create -f raw "$HOME"/"$virtDriveDir"/"$driveName" "$driveSize"
        ;;
    *)
        ;;
esac
