#!/usr/bin/env bash

. "$HOME/.local/lib/xlotus/xlfns"

HELP="$XLOTUS_HELP"

printHelp () {
    cat "$HELP/xl-ff"
    cat "$HELP/footer"
}

case $1 in
    -h|--help) printHelp ;;
    *)
        # get firefox command (e.g. firefox or firefox-developer-edition)
        ffcmd="$(getConfig ff_cmd)"
        # get filter from config (also prevent duplicate entries)
        ffbegin=($(getConfig ff_begin | tr ' ' '\n' | awk '!x[$0]++' | tr '\n' ' '))

        # make sed filter to reorder according to config
        for i in "${ffbegin[@]}";
        do
            # check if profile from filter is available
            checkProfile=$(ls "$HOME/.mozilla/firefox/" | grep ".${i}$")
            # if only the profile exists
            if [ -n "$checkProfile" ]; then
                sedDel+="/$i/d;"
                sedAdd+=".$i\n"
            fi
        done

        ffprofile=$(ls "$HOME/.mozilla/firefox/" |\
                sed "/Pending Pings/d; /profiles.ini/d; /installs.ini/d; /Crash Reports/d; $sedDel" |\
                sed "1 s/^/$sedAdd/" |\
                awk -F '.' '{printf "%2s %s\n", "", $2}' |\
                fzfcmd "Firefox" |\
                sed 's/[[:space:]]//g;')

        if [ -n "$ffprofile" ]; then
            nohup bash -c "$ffcmd --name \"firefox-$ffprofile\" -P $ffprofile &" 2&>/dev/null
        fi
        ;;
esac
