#!/usr/bin/env bash

. "$HOME/.local/lib/xlotus/xlfns"

HELP="$XLOTUS_HELP"

printHelp () {
    cat "$HELP/xl-ff"
    cat "$HELP/footer"
}

case $1 in
    -h|--help) printHelp ;;
    *)
        # get firefox command (e.g. firefox or firefox-developer-edition)
        ffcmd="$(getConfig ff_cmd)"
        # get filter from config (also prevent duplicate entries)
        ffbegin=($(getConfig ff_begin | tr ' ' '\n' | awk '!x[$0]++' | tr '\n' ' '))

        # Icons for filters
        fficon=($(getConfig ff_icon))

        # make sed filter to reorder according to config
        counter=0
        for i in "${ffbegin[@]}";
        do
            # check if profile from filter is available
            checkProfile=$(ls "$HOME/.mozilla/firefox/" | grep ".${i}$")
            # if only the profile exists
            if [ -n "$checkProfile" ]; then
                sedDel="$sedDel/$i/d;"
                sedAdd="$sedAdd.${fficon[$counter]}   $i\n"
                counter=$((counter+1))
            fi
        done

        ffprofile=$(ls "$HOME/.mozilla/firefox/" |\
                sed "/Pending Pings/d; /profiles.ini/d; /installs.ini/d; /Crash Reports/d; $sedDel" |\
                sed "1 s/^/$sedAdd/" |\
                awk -F '.' '{print $2}' |\
                awk '{if($2==""){printf "%1s %-3s %s\n","","ï‰©",$1}else{printf "%1s %s\n","",$0}}' |\
                fzfcmd "Firefox" |\
                sed 's/[^a-zA-Z\-]//g;')

        if [ -n "$ffprofile" ]; then
            nohup bash -c "$ffcmd --name \"firefox-$ffprofile\" -P $ffprofile &" 2&>/dev/null
        fi
        ;;
esac
