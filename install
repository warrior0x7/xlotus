#!/usr/bin/env bash

# ----------------------------------------------
#   VARIABLES
# ----------------------------------------------
XLOTUS_CFG="$HOME/.config/xlotus"
XLOTUS_BIN="$HOME/.local/bin"
XLOTUS_LIB="$HOME/.local/lib/xlotus"
XLOTUS_HELP="$HOME/.local/share/xlotus/help"
XLOTUS_CACHE="$HOME/.cache/xlotus"
# ----------------------------------------------



# ----------------------------------------------
#   FUNCTIONS
# ----------------------------------------------
# Help page
printHelp () { cat "help/install" ;}

# "Success" text (green)
stxt () { echo -e "\033[0;32m[OK]\033[0m $1" ;}
# "Error" text (red)
etxt () { echo -e "\033[0;31m[ERR] $1\033[0m" ;}
# "Removed" text (blue)
rtxt () { echo -e "\033[0;34m[REM] $1\033[0m" ;}

# If directory does not exist, make it
chkmk () { 
    if [ ! -d "$1" ]; then 
        mkdir -p "$1"
        stxt "Created directory: $1" 
    fi
}

# Commands to run with the main function
add () { cp -r "$@" ;}
link () { ln -s "$(pwd)"/$@ ;}

main () {
    for i in "$2"/*
    do
        itemName="$(echo "$i" | awk -F '/' '{print $NF}')"
        itemType="$(file -bi "$i" | awk -F ';' '{print $1}')"
        itemDest="$3/$itemName"
        if [ "$itemType" != "inode/directory" ]; then
            if [ -f "$itemDest" ]; then
                fileType=$(file -bi "$itemDest" | awk -F ';' '{print $1}')
                if [ "$1" == "add" ] && [ "$fileType" == "inode/symlink" ]; then
                    rm -rf "$itemDest"
                    rtxt "Removed '$itemName' (link)"
                    $1 "$i" "$3"
                    stxt "Added '$itemName' ($2)"
                elif [ "$1" == "link" ] && [ "$fileType" != "inode/symlink" ]; then
                    rm -rf "$itemDest"
                    rtxt "Removed '$itemName' ($2)"
                    $1 "$i" "$3"
                    stxt "Added '$itemName' (link)"
                fi
            else
                $1 "$i" "$3"
                stxt "Added '$itemName' ($2)"
            fi
        else
            chkmk "$3/${i/*\//}"
            main "$1" "$i" "$3/$itemName"
        fi
    done
}

# Message to print when installation is a success.
success () {
    echo -e "\n\033[0;32mInstallation was a success!\033[0m"
    echo -e "\nDon't forget to add \033[0;32m\$HOME/.local/bin\033[0m to your PATH variable"
}
# ----------------------------------------------



# ----------------------------------------------
#   PRE-INSTALLATION SETUP
# ----------------------------------------------
# Setup directories
chkmk "$XLOTUS_CFG"
chkmk "$XLOTUS_BIN"
chkmk "$XLOTUS_LIB"
chkmk "$XLOTUS_HELP"
chkmk "$XLOTUS_CACHE"

# If no arguments provided, use --all
if [ -z "$1" ]; then
    stxt "No arguments provided, so I'll be using '--all'"
    opt="--all"
else
    opt="$1"
fi
# ----------------------------------------------



# ----------------------------------------------
#   PROCESS OPTIONS
# ----------------------------------------------
case $opt in
    -a|--all)
        main add "bin" "$XLOTUS_BIN"
        main add "cfg" "$XLOTUS_CFG"
        main add "lib" "$XLOTUS_LIB"
        main add "help" "$XLOTUS_HELP"
        success
        ;;

    -d|--dev)
        main link "bin" "$XLOTUS_BIN"
        main link "cfg" "$XLOTUS_CFG"
        main link "lib" "$XLOTUS_LIB"
        main link "help" "$XLOTUS_HELP"
        success
        ;;

    -h|--help)
        if [ -z "$2" ]; then
            cat help/install
        else
            if [ -f help/"$2" ]; then
                cat help/"$2"
            else
                etxt "Help page not found"
            fi
        fi
        ;;

    *) 
        if [ -n "$1" ]; then
            ctxt r "Invalid argument '$1'"
        else
            ctxt r "Empty argument"
        fi
        printHelp
        ;;
esac
